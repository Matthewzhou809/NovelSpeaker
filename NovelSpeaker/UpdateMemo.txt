お願い：
βテストを行った後、何も問題がなかった時でも問題が発見されなかったと「報告を入れてください」そうしないとまだテスト中なのか、問題がなかったのかを判断できず、延々と不都合の有無の報告を待ち続ける事になってしまいます。

補足：
βテストが終了した後(AppStore側に同じバージョンのものがリリースされた後)は、AppStore アプリ から ことせかい をダウンロードし直しておくことをおすすめしておきます。

ことせかい 更新履歴

Version 1.1.43 (1.1.82)
- iOS 12 における[〜中略〜]暫定的対応の六回目です
  書き換え対象の文字列を "[\s•・*]"(空白や改行に加えて "•"(BULLET), "・"(KATAKANA MIDDLE DOT), "*") に拡大しました。
  "•"(BULLET) なども読み上げられない文字列なのですが、"α•α•α•α" といった文字列を読み上げさせるとずれが発生するけれど、"ααααα" であればずれは発生しないので、とりあえずの対策です。とはいえ、何故そうなるのかはさっぱりわからないため そもそもこれでいいのかどうかさっぱりわからないので、これでまた暫くβテスターの皆さんと一緒に使ってみてずれが発生する場合を発見しつつ潰して…… という感じでしょうか……
  ただ、読み上げに使う文字を変更する形での対応には限界があるであろうことはわかってきたのと、ずれが生じる例が報告されることも少なくなってきたような感じなので、この問題については Appleさん 側がなんとかしてくれるまでは根本的解決はできない事と諦めて、このバージョンで致命的な問題がでなければそれで一旦リリースしてしまおうかと思っています。
- iOS 12 における[〜中略〜]暫定的対応の五回目でやたら遅くなった部分を高速化しました(仕組みは少し変わりますがやってることの意味は変わらないはずです)
- 読み上げ中の位置表示に関する計算方法を変更しました。
  読み上げ開始位置の指定に長押しして範囲選択したり、読み上げ中に表示される読み上げ位置などの位置表示が「合わない時がある」から「合わない時でもまぁ、だいたいあってる」に変わるはずです。
  もちろん、読み上げ中の位置がずれる問題が発生している時はどうしようもなくずれます。
- 読み上げ中に無音の音を鳴らし続ける事でバックグラウンド再生中に再生が停止するのを回避しようとする試み(一つ前の ビルド番号 1.1.81 でデバッグ設定を呼び出してONしていたもの)を常時ONにするようにしてみました。
  それほど消費電力は増えないみたいというのと、1.1.81 で次の章に移動する時にやたら時間がかかって再生が止まるというのがこの対策で結構効果がありそう(OFFの時に10回やって9回再生が止まっていたのが、ONにしたら10回やって10回止まらなかったので効果が無い事は無いと思われる)なので。
  ただ、原因がわからないままの対策なので、直しましたとは言えず、リリース告知文には書きにくいですね。(´・ω・`)


Version 1.1.43 (1.1.81)
- iOS 12 における、読み上げ中の文字の表示位置がおかしくなる場合についての暫定的対応の五回目です
  どうやら改行文字でも読み上げ中の文字の表示位置がおかしくなることがありましたので、改行文字についても "α" に変換して読み上げさせることにしました。
  ただ、一旦読み上げ用の文字列を生成した後に改めて空白文字を一括して変換するという事をしていて、その時に正規表現によるマッチを使うため、変換作業に結構な時間がかかるようになります。
  と、いうことで、お手数をおかけしてしまっているのですが再度「設定タブ」→「iOS 12 で読み上げ中の読み上げ位置表示がおかしくなる場合への暫定的対応を適用する」をONにした状態で「あるふぁ」と読み上げられてしまうであるとか、読み上げ中の表示位置がおかしくなる場合を発見したら教えて頂けると嬉しいです。
  ただ、四回目のもので既にあまり「表示位置がおかしくなった」という報告は寄せられなくなっており、おそらく今回の修正で一応は大丈夫なのではないか……？という期待を持っています。なお、「あるふぁ」と読み上げられてしまったという報告は今の所1件もよせられておりませんのでそちらは多分大丈夫なんじゃないかなぁと思っています。
  なお、表示位置がおかしくなるのを確認した方は、問題の起きた文章そのものが開発者側の端末でも再生させてみることができるように、
  - 問題の起きた小説の名前(とできればURL)、問題の起きた小説の取り込み方(なろう検索経由なのかWeb取込経由なのか)、問題の起きた章(ページ)
  - 自作小説など、取り込むものでない場合はその本文そのもの(できればテキストファイルとしての添付が望ましい)
  - 問題の起こし方(どの部分から読み上げを開始するとどのようにズレるのか)
  - 可能であれば読み替え辞書や読み上げの間の設定(設定タブ -> 再ダウンロード用データの生成 -> 軽量バックアップ で生成されたバックアップデータに含まれます)
  を送って頂けると助かります。
- 設定タブ -> ルビはルビだけ読む を10回ON/OFF(ON->OFF->ONで1回なら5回)で出てくるデバッグ設定に、「再生中に無音の音を鳴らし続けることでバックグラウンド再生中に再生が停止しすることがないように祈る」のON/OFF設定を追加
  正直効果があるかどうかさっぱりわからないのですが、作ったのを忘れないようにデバッグメニューに入れておきます。
  これは、「バックグラウンド再生中に再生が止まり、アプリを表示してバックグラウンドからフォアグラウンドに戻した時に再生が再開する」ような問題に対して、あるいはこれで直ったりするのでは？という事をするためのものです。
  なのですが、これで直ったかどうかを確認するためには「バックグラウンド再生中に再生が止まり、アプリを表示してバックグラウンドからフォアグラウンドに戻した時に再生が再開する」という問題が確実に再現するような操作手順が明らかになっていないと、そもそもこの対策でバックグラウンド再生が止まらなくなったのか、単にバックグラウンド再生が止まらなかっただけなのかの確認ができません。
  そのためこれを正式にその対策とするわけにもいかず、とりあえず隠し機能てきなデバッグメニューに入れておくことにしました。
  とりあえず、バックグラウンド再生で再生が止まるのが嫌だなぁと思っている人はこの機能をONにして生活してみて、
  その状態でバックグラウンド再生が止まった(フォアグラウンドに戻したら再生が再開した)場合には、「やっぱりこの方法は効果がないようです」と連絡して欲しいです。

Version 1.1.43 (1.1.80)
- 設定タブの読み上げ時の間の設定 で、個別の設定を変えたり追加した後に読み上げ時の間の設定に戻ってもそれらの変更が反映された表示にならない問題を修正
- iOS 12 における、読み上げ中の文字の表示位置がおかしくなる場合についての暫定的対応の四回目は継続中です
  この修正は本当にこれで良いのかの自信を持てるようにするためにもう暫くβテスターの方々と一緒に使い倒してみて不都合が出てこないのを確認したいです。
  前回(1.1.79)のものと同じ内容を以下に挙げておきます。
- 前回(1.1.78)では空白とみなされる文字を正規表現での \s (https://developer.apple.com/documentation/foundation/nsregularexpression#1965589 によると [\t\n\f\r\p{Z}] と同じ意味) で表現していたのを、[\t\f\p{Z}] に変更しました。
というのは、「設定」->「読み上げ時の間の設定」で「<改行>」を対象にしたものがあった場合に、その間の設定よりも優先して空白を "α" に読み替える設定が適用されてしまっていたため、これを回避するための処置になります。
ただ、ちょっと気になっているのは、この「読み上げ中に読み上げ位置がおかしくなる」問題は改行を含む文字を読み上げようとした時にも発生するのではないか、という事です。ただ、そのような報告は今の所入ってきていないように見えるので多分……きっと……大丈夫……？なの？かな……？と思ってこれで行ってみる事にします。

Version 1.1.43 (1.1.79)
- 1.1.78 で追加した「設定」->「iOS 12 で読み上げ中の読み上げ位置表示がおかしくなる場合への暫定的対応を適用する」で出るダイアログで、iPhone SE 等ではダイアログが縦に長くなりすぎてOKボタンが押せなくなっていた問題を解消
- iOS 12 における、読み上げ中の文字の表示位置がおかしくなる場合についての暫定的対応の四回目です。
  - 前回(1.1.78)では空白とみなされる文字を正規表現での \s (https://developer.apple.com/documentation/foundation/nsregularexpression#1965589 によると [\t\n\f\r\p{Z}] と同じ意味) で表現していたのを、[\t\f\p{Z}] に変更しました。
    というのは、「設定」->「読み上げ時の間の設定」で「<改行>」を対象にしたものがあった場合に、その間の設定よりも優先して空白を "α" に読み替える設定が適用されてしまっていたため、これを回避するための処置になります。
    ただ、ちょっと気になっているのは、この「読み上げ中に読み上げ位置がおかしくなる」問題は改行を含む文字を読み上げようとした時にも発生するのではないか、という事です。ただ、そのような報告は今の所入ってきていないように見えるので多分……きっと……大丈夫……？なの？かな……？と思ってこれで行ってみる事にします。
    ということでとりあえずはこの状態で暫く使ってみて問題が発生しないことを見極めてからリリースをしようかなぁと思いたいです(前回も前々回も同じことを思っていたので3度目の正直になればいいなぁ……)

Version 1.1.43 (1.1.78) (1.1.77 は欠番)
- iOS 12 において、読み上げ中の文字の表示位置がおかしくなる場合がある問題への暫定的対処のON/OFF設定を追加
  - iOS 12 における、読み上げ中の文字の表示位置がおかしくなる場合についての暫定的対応の三回目です。
    今回は「正規表現を使って空白とみなされる文字の並び("\s+")を、"α" に置き換えて読み上げさせるようにする」かどうかのON/OFFの設定を追加しました。
    これは、少なくとも今の所の iOS の音声合成エンジンでは "α" を発話しないため、これを空白文字の代わりにしようというものです。
    ただ、読み替え先を "α" にするというのは、いつ何時音声合成エンジン側で "α" を発話するようになるかわからないので爆弾をかかえるような事になるんですよね……
    なので、暫定的対応であることを明示した上でオプションでON/OFFができるような形にしました。
    初期値ではOFFになっています。

  と、いうことなので、できましたらば、βテスターの方々で
   - 読み上げ中の表示位置がずれる
   - 空白があるべきところで「あるふぁ」などといった謎の誤読み上げが発生する
  というような事が「ない」事を確認して頂ければと思う……ん……ですが……
  そういう「無い事」を確認するのはいわゆる悪魔の証明……ですよねぇ……これはちょっと長い期間ドッグフーティングするしかなさそうですね……('A`)
  - ON/OFFの設定が追加されたことにより、「設定」→「再ダウンロード用データの生成」で生成されるバックアップデータに「iOS 12 で読み上げ中の読み上げ位置がおかしくなる場合への暫定的対応を適用する」のON/OFF設定が追加されます。

Version 1.1.43 (1.1.76)
- iOS 12 における、読み上げ中の文字の表示位置がおかしくなる場合についての暫定的対応の二回目です。
  今回は "　"(全角スペース) があると表示位置が更新されなくなるという問題があったので "　"(全角スペース) を "  "(半角スペース2つ) に読み替えさせます。
  - 前回の対応では取り込んだ保存されるデータを書き換えましたが、今回は保存されるデータには手を付けずに、
    表示時まではそのままで、読み上げ時に半角スペース2つになるように読み替え辞書に潜ませるという方法を取っています。
    つまり実装方法が変わっているので効果が出ない場合があるかもしれません。
  - とりあえず全角スペースで駄目になるのを試してみるには、自作小説を追加して、内容を「あいうえお　かきくけこ」("お"と"か"の間が全角スペース)というものにしたものを作れば試せるかと思います。
- おそらくこれら2つ("\u2028" と 全角スペース)以外のものもありそうな予感がするので気づかれた方は教えてください……(´・ω・`)
  - なんとなく、画面表示上は何も表示されない系で、かつASCII文字コードには無い領域の物(≒全角の記号系の表示されないもの)が
    表示位置をおかしくする原因になっているんじゃないかなぁという気がしています。
    なのですが、そんなのどう探すといいんですかね。もしかしてUTF-8を全部見ていかないとだめなんですかね……('A`)
- iPhone X 等のノッチのある iPhone では NetworkActivityIndicator(画面上部の時間やバッテリ状態が表示されている当たりに出てくるくるくる回るアレ)がなくなったらしいので、代わりに K.I.T.T みたいな左右にふゎんふゎんする表示をしてくれる FTLinearActivityIndicator というのを導入
  - なお、ことせかい では NetworkActivityIndicator をダウンロード中の表示に使っています

Version 1.1.43 (1.1.75)
- 外部ライブラリのバージョンを現時点での最新のものに更新しました
  - 色々なところで使っているのでどこが変わったとかは書けません(´・ω・`)
- ビルド環境を Xcode 11 から Xcode 12 に更新しました
  - Xcode に言われるがままに Swift 部分を Swift 4.2 へコンバートしました(ざっと眺めた範囲では特に問題になりそうな変更は見当たりませんでした)
- 読み上げ中の表示位置を動かす命令が main thread 以外から呼ばれる可能性を減らしました(読み上げ中に落ちる問題のうちほんの一部(もしかすると発生しない問題かもしれない位少ない可能性のもの)がなくなります)
- 読み上げ中の文字表示に使っている選択範囲が表示されない可能性があった問題を修正(こちらもその問題は発生していなかったかもしれない位のもの)
- iOS 12 において、読み上げ中の文字の表示位置がおかしくなる場合があった問題への暫定的対処をした(全ての問題が解決するわけではなく、一部に対して(具体的に言うと "\u2028" が入っている場合には多分確実に起こる問題であったのでこれを "\n" に変更するようにした)。しかし、別のパターンで同様の問題が起きることが確認されており(例えば "long sentence. long long sentence. long long long sentence..." という感じのものを読み上げさせると発生する)、全てが対処できたわけではない)
  - 確認するには "\u2028" が小説の本文に入っていないと駄目なので、とりあえず
    イリヤの空、UFOの夏@カクヨム/正しい原チャリの盗み方・後編 15/15
    https://kakuyomu.jp/works/1177354054885579795/episodes/1177354054886002315
    をWeb取込で取り込んで、多分だいたいどこでもいいのですが、とりあえず『「やるじゃん」そうつぶやいた。』という辺りに読み上げ位置を設定し、
    読み上げを開始すると、実際に読み上げている部分と表示されている読み上げ位置がずれているのが確認できるかと思います。
    あ、ずれるのを見るには AppStore側 からダウンロードして Version 1.1.42 で上書きした状態で、です。
    このバージョンではその小説に関しては正常に動くように修正したつもりです。

Version 1.1.42 (1.1.74)
- キーボードが出るシーンにおいて、キーボードが閉じられない場合があったのを改行を入れるなどで閉じられるように変更
  - 変更を行ったのは以下のシーンになります
    - ユーザ登録小説の編集シーンでの小説名入力時 (改行で消えるようになった)
    - なろう検索 (改行でしか消えなかったのを入力欄以外のタップで消えるようになった)
    - 設定 -> 声質の設定 (スクロール部の上下スワイプでも消えるようになった)
    - 設定 -> 読みの修正 -> 「+」で追加しようとした時 (改行でも入力欄以外のタップでもキーボードは消えなかった)
    - 設定 -> 読み上げ時の間の設定 -> 読み上げ時の間の詳細設定 (改行で消えなかった)

Version 1.1.41 (1.1.73)
- 内部データベースの保存場所を移動しました
  - 起動時に保存場所を確認して移動します。場合によっては
    - 起動時にやたら時間がかかる(ファイルコピーに時間がかかる？移動してるからそうはならないと思うけれども……)
    - データが全部吹き飛んだように見える
    事がありますのでその辺りを注意して確認してみてください。

Version 1.1.41 (1.1.72)
- 「読みの修正」でのテスト読み上げの時に「声質の設定」の標準設定を使うように変更
- 「読みの修正」での正規表現書き換え時に、書き換え先 $* を '\' でエスケープできるように
  - 1.1.71 までは "(あ)" を "\$1$1" と書き換えようとすると '\' によるエスケープがかからないため
    "\ああ" になっていたが、今回の修正で "\$1あ" になるようになった(はず)
    同様に、書き換え先が "\\$1$1" であれば、'\' がエスケープされて "\ああ" になる(はず)

Version 1.1.41 (1.1.71)
- 「読みの修正」で正規表現による読み替えができるように
  - 「読みの修正」を登録する時に正規表現が使えるようになります。
  - 正規表現を使用するか否かのON/OFFが追加されます。
  - この修正により影響の予想される項目は以下になります。
    1. 読みの修正の読み替え文字のリスト表示
      1.1. 読み替え設定の検索時の挙動
      1.2. 読み替え設定を削除した時の挙動
      1.3. 読み替え設定が追加された時の挙動
    2. 読みの修正を入力している部分の表示
    3. 再ダウンロード用データ(完全バックアップ・軽量バックアップどちらでも)の内容(読み替え辞書部分)
    4. 正規表現による読み替え
      - 正規表現は iOS で提供されている NSRegularExpression を使っています。
        https://developer.apple.com/documentation/foundation/nsregularexpression
      - NSRegularExpression で利用可能なメタキャラクタ、オペレータを利用可能になります。
        https://developer.apple.com/documentation/foundation/nsregularexpression#1965589
      - キャプチャした文字について、"$数字" による参照が可能です。
        - 例えば、"([0-9０１２３４５６７８９]+)mb" を "$1メガバイト" に読み替える設定を正規表現として登録すると、
          "1mb" を "いちめがばいと" と読み替えるようになったり、
          "([^\p{Han}])己" を "$1おのれ" と登録すると、"自己" は "じこ" のまま、
          "太郎は己の" を "たろうはおのれの" に読み替えるように指定できるようになります。



Version 1.1.40 (1.1.70)
- 「小説を読む時に背景を暗くする」がONになっているときに、小説本文のスクロールバーが見えなくなっていた問題を修正

Version 1.1.39 (1.1.69)
- 更新履歴の内容の更新のみ

Version 1.1.39 (1.1.68)
- 「設定」タブの「開発者に問い合わせる」内の「報告への返事」を「不要」「無くても良い」「必須」の選択式に変更

Version 1.1.39 (1.1.67)
- |...《...》 の形式のルビにおいて、｜(全角) には反応していなかった問題を修正
  - 問題の確認方法
    1. 「新規自作小説の追加」等で編集可能な本を作成する
    2. 「ルビはルビだけ読む」をONにする
    3. 1. で作った小説に、｜漢字ひらかな漢字《あいうえお》 といったような感じの、漢字とひらがなの混じった物へのルビ記法を書き込む
    4. その部分を読み上げさせてみて、ルビの部分だけが読まれる事を確認する(上記の例の場合、旧クライアントであれば「漢字ひらかなあいうえお」と読み上げられるが、新クライアントでは「あいうえお」となる)

Version 1.1.38 (1.1.66)
- 繰り返し再生時に、読み上げ位置が先頭に戻らない場合があった問題を修正
  - 問題の確認方法
    - ケース1(繰り返し再生:一つの章)：
      1. 任意の小説を開く
      2. 開いた章で読み上げを開始して、途中まで読んだ所で停止する(読み上げ位置が保存される)
      3. 設定タブで「繰り返し再生」を「一つの章」にする
      4. 再生を開始し、章の末尾まで読み上げた所でその章の最初に戻るか否かを確認する(不都合のあるバージョンでは2.で保存した位置に戻ってしまう)
    - ケース2(繰り返し再生:最初から)
      1. 複数の章のある小説を開く
      2. 1章に移動し、読み上げを開始して、途中まで読んだ所で停止する(その章の読み上げ位置が保存される)
      3. 設定タブで「繰り返し再生」を「最初から」にする
      4. 2章以降の章に移動し、再生を開始し、章の末尾まで読み上げた所で1章の最初に戻るか否かを確認する(不都合のあるバージョンでは2.で保存した位置に戻ってしまう)

Version 1.1.37 (1.1.65)
- 設定タブに「繰り返し再生」の項目を追加

Version 1.1.37 (1.1.64)
- アプリ内更新履歴を更新しそこなっていたのを修正

Version 1.1.37 (1.1.63)
- 「再ダウンロード用データの生成」で小説の本文を含むバックアップもできるように
- 対応読み込みファイルタイプに RTF(Rich Text Format) を追加
- 設定タブに「ことせかい について」(バージョン番号の確認)を追加

Version 1.1.37 (1.1.62)
- 「再ダウンロード用データの生成」で保存される設定項目を増加
